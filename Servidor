import socket
import threading
from tkinter import Tk, Text, Entry, Button, END, DISABLED, NORMAL

class ChatServer:
    def __init__(self):
        self.server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        self.server_socket.bind(('127.0.0.1', 5555))
        self.server_socket.listen(1)

        self.client_socket = None

        # Interfaz
        self.root = Tk()
        self.root.title("Servidor - UNAL Chat")
        self.root.geometry("600x550")

        self.chat = Text(self.root, state=DISABLED, wrap="word")
        self.chat.pack(padx=10, pady=10, fill="both", expand=True)


        self.chat.tag_config("me", foreground="red")

        self.entry = Entry(self.root, font=("Arial", 10))
        self.entry.pack(side="left", fill="x", expand=True, padx=10, pady=(0,10))
        self.entry.bind("<Return>", self.enviar)

        self.btn = Button(self.root, text="Enviar", command=self.enviar)
        self.btn.pack(side="right", padx=10, pady=(0,10))

        self.log("ðŸŸ¢ Servidor listo. Esperando cliente...")
        threading.Thread(target=self.aceptar_cliente, daemon=True).start()
        self.root.mainloop()

    def aceptar_cliente(self):
        self.client_socket, addr = self.server_socket.accept()
        self.log(f"âœ… Cliente conectado: {addr}")
        threading.Thread(target=self.recibir, daemon=True).start()

    def recibir(self):
        while True:
            msg = self.client_socket.recv(1024).decode()
            if not msg:
                break
            self.log(f"Cliente: {msg}")

    def enviar(self, event=None):
        msg = self.entry.get().strip()
        if msg and self.client_socket:
            self.client_socket.send(msg.encode())
            self.log(f"Yo: {msg}", quien="me")
            self.entry.delete(0, END)

    def log(self, texto, quien=""):
        self.chat.config(state=NORMAL)
        self.chat.insert(END, texto + "\n", quien)
        self.chat.see(END)
        self.chat.config(state=DISABLED)


if __name__ == "__main__":
    ChatServer()
